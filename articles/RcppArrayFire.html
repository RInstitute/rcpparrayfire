<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to RcppArrayFire • RcppArrayFire</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to RcppArrayFire">
<meta property="og:description" content="RcppArrayFire">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RcppArrayFire</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/RcppArrayFire.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tests_and_coverage.html">Tests and Coverage</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daqana/rcpparrayfire/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to RcppArrayFire</h1>
                        <h4 class="author">Ralf Stubner</h4>
            
            <h4 class="date">2020-09-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/daqana/rcpparrayfire/blob/master/vignettes/RcppArrayFire.Rmd"><code>vignettes/RcppArrayFire.Rmd</code></a></small>
      <div class="hidden name"><code>RcppArrayFire.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p><code>RcppArrayFire</code> provides an <code>Rcpp</code> wrapper for the <a href="http://www.arrayfire.com/">ArrayFire Library</a>, an open source library that can make use of GPUs and other accelerators via CUDA or OpenCL.</p>
</div>
<div id="basic-usage" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-usage" class="anchor"></a>Basic usage</h1>
<div id="calculating-pi-by-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-pi-by-simulation" class="anchor"></a>Calculating <span class="math inline">\(\pi\)</span> by simulation</h2>
<p>Let’s look at the classical example of calculating <span class="math inline">\(\pi\)</span> via simulation. The basic idea is to generate a large number of random points within the unit square. An approximation for <span class="math inline">\(\pi\)</span> can then be calculated from the ratio of points within the unit circle to the total number of points. A vectorized implementation in R might look like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw">piR</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">N</span>) {
    <span class="kw">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>)
    <span class="kw">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>)
    <span class="fl">4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="kw">y</span><span class="op">^</span><span class="fl">2</span>) <span class="op">&lt;</span> <span class="fl">1.0</span>) <span class="op">/</span> <span class="kw">N</span>
}

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">42</span>)
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"pi ~= "</span>, <span class="fu">piR</span>(<span class="fl">10</span><span class="op">^</span><span class="fl">7</span>), <span class="st">"\n"</span>))
<span class="co">#&gt; pi ~=  3.140899</span>
<span class="co">#&gt;        user      system     elapsed </span>
<span class="co">#&gt;       0.836       0.060       0.897</span>
</pre></div>
<p>A simple way to use C++ code in R is to use the inline package or <code>cppFunction()</code> from Rcpp, which are both possible with RcppArrayFire. An implementation in C++ using ArrayFire might look like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">src</span> <span class="op">&lt;-</span> <span class="st">'
double piAF (const int N) {
    array x = randu(N, f32);
    array y = randu(N, f32);
    return 4.0 * sum&lt;float&gt;(sqrt(x*x + y*y) &lt; 1.0) / N;
}'</span>
<span class="kw">Rcpp</span>::<span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span>(code = <span class="kw">src</span>, depends = <span class="st">"RcppArrayFire"</span>, includes = <span class="st">"using namespace af;"</span>)

<span class="kw">RcppArrayFire</span>::<span class="fu"><a href="../reference/arrayfire_set_seed.html">arrayfire_set_seed</a></span>(<span class="fl">42</span>)
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"pi ~= "</span>, <span class="fu">piAF</span>(<span class="fl">10</span><span class="op">^</span><span class="fl">7</span>), <span class="st">"\n"</span>))
<span class="co">#&gt; pi ~=  3.141066</span>
<span class="co">#&gt;        user      system     elapsed </span>
<span class="co">#&gt;       0.000       0.004       0.021</span>
</pre></div>
<p>Several things are worth noting:</p>
<ol style="list-style-type: decimal">
<li><p>The syntax is almost identical. Besides the need for using types and a different function name when generating random numbers, the argument <code>f32</code> to <code>randu</code> as well as the <code>float</code> type catches the eye. These instruct ArrayFire to use single precision floats, since not all devices support double precision floating point numbers. If you want to use double precision, you have to specify <code>f64</code> and <code>double</code>.</p></li>
<li><p>The results are not the same, since ArrayFire uses a different random number generator.</p></li>
<li><p>The speed-up can be quite impressive. However, sometimes the first invocation of a function is not as fast as expected due to the <a href="http://arrayfire.com/performance-of-arrayfire-jit-code-generation/">just-in-time compilation</a> used by ArrayFire.</p></li>
</ol>
</div>
<div id="arrays-as-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#arrays-as-parameters" class="anchor"></a>Arrays as parameters</h2>
<p>Up to now we have only considered simple types like <code>double</code> or <code>int</code> as function parameters and return values. However, we can also use arrays. Consider the matrix product <span class="math inline">\(X^{\mathsf{T}} X\)</span> for a random matrix <span class="math inline">\(X\)</span> in R:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">42</span>)
<span class="kw">N</span> <span class="op">&lt;-</span> <span class="fl">40</span>
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">N</span> <span class="op">*</span> <span class="kw">N</span> <span class="op">*</span> <span class="fl">2</span>), ncol = <span class="kw">N</span>)
<span class="kw">tXXR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">X</span>) <span class="op">%*%</span> <span class="kw">X</span>
</pre></div>
<p>The matrix multiplication can be implemented with RcppArrayFire using the appropriate <a href="http://arrayfire.org/docs/group__blas__func__matmul.htm">matmul function</a>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">src</span> <span class="op">&lt;-</span> <span class="st">'
af::array squareMatrix(const RcppArrayFire::typed_array&lt;f32&gt;&amp; x) {
    return af::matmulTN(x ,x);
}'</span>
<span class="kw">Rcpp</span>::<span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span>(code = <span class="kw">src</span>, depends = <span class="st">"RcppArrayFire"</span>)
<span class="kw">tXXGPU</span> <span class="op">&lt;-</span> <span class="fu">squareMatrix</span>(<span class="kw">X</span>)

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(<span class="kw">tXXR</span>, <span class="kw">tXXGPU</span>)
<span class="co">#&gt; [1] "Mean relative difference: 1.372856e-07"</span>
</pre></div>
<p>Since an object of type <code>af::array</code> can contain different <a href="http://arrayfire.org/docs/defines_8h.htm#a023d8ac325fb14f1712a52fb0940b1d5">data types</a>, the templated wrapper class <code>RcppArrayFire::typed_array&lt;&gt;</code> is used to indicate the desired data type when converting from R to C++. Again single precision floats are used with ArrayFire, which explains the difference between the two results. We can be sure that double precision is supported by switching the computation backend to “CPU”, which produces identical results:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">src</span> <span class="op">&lt;-</span> <span class="st">'
af::array squareMatrixF64(const RcppArrayFire::typed_array&lt;f64&gt;&amp; x) {
    return af::matmulTN(x ,x);
}'</span>
<span class="kw">Rcpp</span>::<span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span>(code = <span class="kw">src</span>, depends = <span class="st">"RcppArrayFire"</span>)

<span class="kw">RcppArrayFire</span>::<span class="fu"><a href="../reference/arrayfire_set_backend.html">arrayfire_set_backend</a></span>(<span class="st">"CPU"</span>)
<span class="kw">tXXCPU</span> <span class="op">&lt;-</span> <span class="fu">squareMatrixF64</span>(<span class="kw">X</span>)
<span class="kw">RcppArrayFire</span>::<span class="fu"><a href="../reference/arrayfire_set_backend.html">arrayfire_set_backend</a></span>(<span class="st">"DEFAULT"</span>)

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(<span class="kw">tXXR</span>, <span class="kw">tXXCPU</span>)
<span class="co">#&gt; [1] TRUE</span>
</pre></div>
</div>
</div>
<div id="usage-in-a-package" class="section level1">
<h1 class="hasAnchor">
<a href="#usage-in-a-package" class="anchor"></a>Usage in a package</h1>
<p>More serious functions should be defined in a permanent fashion. To facilitate this, RcppArrayFire contains the function <code>RcppArraFire.package.skeleton()</code>. This functions initialises a package with suitable <code>configure</code> script for linking with ArrayFire and RcppArrayFire. In order to implement new functionality you can then write C++ functions and save them in the <code>src</code> folder. Functions that should be callable from R should be marked with the <code>[[Rcpp::export]]</code> attribute. See the Rcpp vignettes on <a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-attributes.pdf">attributes</a> and <a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-package.pdf">package writing</a> for further details.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kazuki Fukui, Ralf Stubner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
